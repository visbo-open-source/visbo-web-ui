<div class='well' (resized)="onResized($event)">
  <div  class='container-fluid mb-2'>

    <div class="row row-cols-1 row-cols-lg-2">
      <div class="col col-sm-12 col-lg-8">
        <div class="text-dark">
          <div *ngIf="!getPreView()" class="row ml-1 pt-2 d-print-none">
            <span >
              <label class="mr-2 pt-1">{{ 'ViewCapacity.titleCapacity' | translate }}</label>
            </span>
            <span>
              <input id="capacityFrom" type="date" class="border-1 font-weight-bold" name="capacityFrom" min= "2015-01-01" max="2050-01-01" [ngModel]="capacityFrom | date:'yyyy-MM-dd'" (input)="capacityFrom=parseDate($event.target.value)" (change)="updateDateRange()" >
            </span>
            <span>
              <label class="mx-2 pt-1">{{ 'ViewCapacity.titleTimeTo'  | translate }}</label>
              <input id="capacityTo" type="date" class="border-1 font-weight-bold" name="capacityTo" min= "2015-01-01" max="2050-01-01" [ngModel]="capacityTo | date:'yyyy-MM-dd'" (input)="capacityTo=parseDate($event.target.value)" (change)="updateDateRange()" >
            </span>
            <div class="mx-2 pt-1">
              <span *ngIf="hasCost" class="mr-auto">{{ 'ViewCapacity.title2'  | translate }}</span>
              <span *ngIf="hasCost" class="mr-auto dropdown">
                <a class="pl-2 font-weight-bold dropdown-toggle" data-toggle="dropdown" >
                  {{showUnitText}}
                </a>
                <div class="dropdown-menu">
                  <a class="dropdown-item" (click)="updateShowUnit('PD')">{{ 'ViewCapacity.lbl.pd' | translate }}</a>
                  <a class="dropdown-item" (click)="updateShowUnit('Euro')">{{ 'ViewCapacity.lbl.euro' | translate }}</a>
                </div>
              </span>
            </div>
          </div>
          <div *ngIf="!getPreView()" class="d-flex flex-wrap d-print-none mt-1">
            <div *ngIf="!vpvActive" class="custom-control custom-checkbox m-2">
              <input type="checkbox" class="custom-control-input" (change)="updateRef()" id="idRefPFV" [(ngModel)]="refPFV">
              <label class="custom-control-label" for="idRefPFV">{{ 'ViewCapacity.lbl.refPFV' | translate }}</label>
            </div>

            <div *ngIf="!getPreView()" class="d-flex flex-wrap d-print-none">
              <label for="drillDownOpt" class="col-3 col-form-label">{{ 'ViewCapacity.lbl.showDrill' | translate }}:</label>
              <select class="col-9 form-control" id="drillDownOpt" (change)="updateDrillDown()" name="drillDown" [(ngModel)]="drillDown">
                <option *ngFor="let drillItem of drillDownCapaFiltered" value="{{drillItem.id}}">{{drillItem.localName}}</option>
              </select>
            </div>

            <div *ngIf="!getPreView()" class="d-flex flex-wrap d-print-none">
              <button type="button" class="btn btn-md btn-light ml-1" id="exportExcel" (click)='exportExcel()'>
                {{ 'vpfVersion.btn.exportExcel' | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="visboCapacity && visboCapacity.length > 0" class="col-sm-12 col-md-10 col-lg-4 card align-right px-0">
        <h5 class="card-header p-2">
          <strong class="mr-1"><ng-container *ngTemplateOutlet="indicator; context:{level: getLevel(sumCost, sumBudget)}"></ng-container></strong>
          {{ 'ViewCapacity.titleBox' | translate }}</h5>
        <div class="card-body p-2">
          <div class="row">
            <div class="col col-sm-6">
              <div *ngIf="showUnit != 'PD'">
                {{ 'ViewCapacity.lbl.totalCost' | translate }}
              </div>
              <div *ngIf="showUnit == 'PD'">
                {{ 'ViewCapacity.lbl.totalCostPT' | translate }}
              </div>
            </div>
            <div class="col col-sm-6 text-right">
              <strong class="mr-1"><ng-container *ngTemplateOutlet="indicator; context:{level: getLevel(sumCost, sumBudget)}"></ng-container></strong>
              {{sumCost | number:'1.0-0'}}
              <span *ngIf="showUnit != 'PD'">Tâ‚¬</span>
              <span *ngIf="showUnit == 'PD'">{{ 'ViewCapacity.lbl.pd' | translate }}</span>
            </div>
          </div>
          <div class="row">
            <div class="col col-sm-6" title="{{ 'keyMetrics.longBAC' | translate }}">
              <div *ngIf="refPFV">
                {{ 'ViewCapacity.lbl.budget' | translate }}
              </div>
              <div *ngIf="!refPFV">
                {{ 'ViewCapacity.lbl.totalCapa' | translate }}
              </div>
            </div>
            <div class="col col-sm-6 text-right">
              {{sumBudget | number:'1.0-0'}}
              <span *ngIf="showUnit != 'PD'">{{ 'ViewCapacity.lbl.keuro' | translate }}</span>
              <span *ngIf="showUnit == 'PD'">{{ 'ViewCapacity.lbl.pd' | translate }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div>
    <div class="row">
      <div *ngIf="orgaTreeData && !getPreView()" class="pl-3 col-3 border-right scroll d-print-none">
        <span class="pt-2 text-dark font-weight-bold" title="{{ 'ViewCapacity.lbl.orgaValid' | translate }} {{vcOrganisation.timestamp | date: 'dd.MM.yyyy'}}">{{ 'ViewCapacity.title1'  | translate }}</span>
        <ng-container *ngTemplateOutlet="recursiveList; context:{ $implicit: orgaTreeData.children, level: 0 }" ></ng-container>
      </div>
      <div *ngIf="!getPreView() && displayCapacity() > 0" class="col-9">
        <div *ngIf="graphDataComboChart.length > 2" >
            <app-combo-chart [graphData]="graphDataComboChart" [graphOptions]="graphOptionsComboChart" [parentThis]="parentThis" [language]="currentLang"></app-combo-chart>
        </div>
      </div>
      <div *ngIf="getPreView() && displayCapacity() > 0" class="col-12">
        <div *ngIf="graphDataComboChart.length > 2" >
          <app-combo-chart [graphData]="graphDataComboChart" [graphOptions]="graphOptionsComboChart" [parentThis]="parentThis" [language]="currentLang"></app-combo-chart>
        </div>
      </div>
      <!-- here will be shown the text: No Capacity the spinner -->
      <div *ngIf="displayCapacity() == 0" class="col-9">
        <span class="pt-2  text-dark font-weight-bold">{{ 'ViewCapacity.msg.noCapacity' | translate }}</span>
      </div>
    </div>
  </div>


  <!-- Here are the definitions in HTLM, Angular and Bootstrap for the organisation-tree, chooseable with click on the item, expandable with brackets -->
  <ng-template #recursiveList let-list let-level="level">
    <div *ngFor="let item of list" style="white-space: nowrap;">
      <div class="dropdown-item tree-item" (click)="selectLeaf(item)"
      [ngClass]="{'tree-item__selected': item.isSelected === 'SELECTED', 'tree-item__parent-selected': item.isSelected === 'PARENT_SELECTED'}">
        <span [style.margin-left]="(level * 20) + 'px'"> <!--indentation for the tree structure -->
          <a (click)="$event.stopPropagation(); switchLeaf(item);">
            <i class="fa" [ngClass]="{'fa-chevron-right': !item.showChildren, 'fa-chevron-down': item.showChildren}"></i>
          </a>
          <span class="ml-sm-1">
            {{item.name}} <!-- {{item.isSelected}} -->
          </span>
          <span *ngIf="capaLoad[item.uid] && capaLoad[item.uid].rankOver > 0" class="ml-sm-1">
            <strong class="fas fa-arrow-up" style="color:red"></strong>
          </span>
          <span *ngIf="capaLoad[item.uid] && capaLoad[item.uid].rankUnder > 0" class="ml-sm-1">
            <strong class="fas fa-arrow-down" style="color:green"></strong>
          </span>
        </span>
      </div>
      <div *ngIf="item.children?.length > 0 && item.showChildren" [ngStyle]="{'list-style-type': 'none'}">
        <ng-container *ngTemplateOutlet="recursiveList; context:{ $implicit: item.children, level: level + 1 }"></ng-container>
      </div>
    </div>
  </ng-template>
  <!-- End of definitions for the OrgaTree -->

  <ng-template #indicator let-level="level">
    <i class="fa" [ngClass]="{'fa-check-circle text-success': level == 1, 'fa-exclamation-triangle text-warning': level == 2, 'fa-exclamation-circle text-danger': level == 3}"></i>
  </ng-template>

  <div *ngIf="displayCapacity() < 0" >
    <div class="spinner-border" role="status"></div>
    <span> {{ 'ViewCapacity.msg.calculating' | translate }}</span>
  </div>
</div>
