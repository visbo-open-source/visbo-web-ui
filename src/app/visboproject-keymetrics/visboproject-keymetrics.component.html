<app-usernavbar></app-usernavbar>
<div class='well'>
  <div *ngIf="vpActive" class='row'>
    <div class='col'>
      <h2 *ngIf="vpActive">
        {{ 'vpKeyMetric.title' | translate }}: <a (click)="gotoVPDetail(vpActive)">{{vpActive.name}}</a>
        <span *ngIf="dropDownIndex > 0" class="ml-1"> ({{dropDown[dropDownIndex]}})</span>
        <span *ngIf="dropDown.length > 1" class="dropdown" class="ml-2">
          <a class="dropdown-toggle" data-toggle="dropdown" style="!important"></a>
          <div class="dropdown-menu">
            <div *ngFor="let item of dropDown">
              <a *ngIf="!isActiveVariant(item)" class="dropdown-item" (click)="switchVariant(item)">{{ item }}</a>
            </div>
          </div>
        </span>
        <small *ngIf="vpvActive" data-toggle="modal" data-target="#VpvDetails" class="mx-2" title="{{ vpvActive.ampelErlaeuterung }}">
          <ng-container *ngTemplateOutlet="trafficLight; context:{level: vpvActive.ampelStatus} " ></ng-container>
        </small>
      </h2>
      <h5>{{ 'vpKeyMetric.lbl.vc' | translate }}:
        <a *ngIf="hasVCPerm(permVC.View)" (click)="gotoVC(vpActive)">{{ vpActive.vc.name }}</a>
        <span *ngIf="!hasVCPerm(permVC.View)">{{ vpActive.vc.name }}</span>
      </h5>
    </div>
  </div>

  <div *ngIf="vpvActive">
    <div class="row">
      <h4 class="col-6 text-dark">
        <div class="d-none d-lg-block" title="{{ vpvActive.timestamp | date :'dd.MM.yyyy HH:mm'}}">{{ 'vpKeyMetric.titleVersion' | translate }}: {{ vpvActive.timestamp | date :'dd.MM.yyyy'}}</div>
        <div class="d-block d-lg-none">V.: {{ vpvActive.timestamp | date :'dd.MM.'}}</div>
      </h4>
      <div class="col-6">
        <div class="row">
          <span style="font-size: 2.2em" class="mx-1 fas fa-caret-square-left" title="Previous Period before {{refDate | date :'dd.MM.'}}" (click)='getNextVersion(-1)'></span>
          <select class="col-4 form-control d-none d-md-block" name="refDateInterval" [(ngModel)]="refDateInterval">
            <option value="day">{{ 'vpKeyMetric.lbl.day' | translate }}</option>
            <option value="week">{{ 'vpKeyMetric.lbl.week' | translate }}</option>
            <option value="month">{{ 'vpKeyMetric.lbl.month' | translate }}</option>
            <option value="quarter">{{ 'vpKeyMetric.lbl.quarter' | translate }}</option>
          </select>
          <span style="font-size: 2.2em" class="mx-1 fas fa-caret-square-right" title="Next Period after {{refDate | date :'dd.MM.'}}" (click)='getNextVersion(+1)'></span>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid" *ngIf="vpvActive">
    <div class="row">
      <div class="col-9 btn-toolbar" style="padding: unset;">
        <button type="button" class="btn btn-md btn-light mr-1" (click)="switchView('KeyMetrics')">{{ 'vpKeyMetric.btn.vpKeyMetric' | translate }}</button>
        <button *ngIf="hasVPPerm(permVP.Modify + permVP.ViewAudit) && hasOrga" type="button" class="btn btn-md btn-light mr-1" (click)="switchView('Capacity')">{{ 'vpKeyMetric.btn.vpCapacity' | translate }}</button>
        <div class="btn-group">
          <button class="btn btn-md btn-light dropdown-toggle"  data-toggle="dropdown">
            {{ 'vpKeyMetric.btn.vpView' | translate }}
            <span class="caret"></span>
          </button>
          <div class="dropdown-menu">
            <a *ngIf="hasKM(vpvActive.keyMetrics, 'Costs') && hasOrga" class="dropdown-item" (click)="switchView('Costs')">{{ 'vpKeyMetric.lbl.metricCost' | translate }}</a>
            <a *ngIf="hasKM(vpvActive.keyMetrics, 'Deadlines')"  class="dropdown-item" (click)="switchView('Deadlines')">{{ 'vpKeyMetric.lbl.metricDeadline' | translate }}</a>
            <a *ngIf="hasKM(vpvActive.keyMetrics, 'Deliveries')"  class="dropdown-item" (click)="switchView('Deliveries')">{{ 'vpKeyMetric.lbl.metricDelivery' | translate }}</a>
            <a class="dropdown-item" (click)="switchView('All')">{{ 'vpKeyMetric.btn.vpViewAll' | translate }}</a>
          </div>
        </div>
      </div>
    </div>
    <hr>

    <div *ngIf="currentView == 'KeyMetrics' || currentViewKM">
      <app-comp-viewkeymetrics [visboprojectversions]="visboprojectversions" [vpvid]="vpvActive._id" [combinedPerm]="combinedPerm" (switchViewChild)="switchViewParent($event)"></app-comp-viewkeymetrics>
    </div>

    <div *ngIf="currentView == 'Capacity'">
      <app-comp-viewcapacity [vpActive]="vpActive" [vpvActive]="vpvActive" [combinedPerm]="combinedPerm"></app-comp-viewcapacity>
    </div>

    <div *ngIf="currentView == 'Costs'">
      <app-comp-viewcost [vpvActive]="vpvActive" [combinedPerm]="combinedPerm"></app-comp-viewcost>
    </div>

    <div *ngIf="currentView == 'Deadlines'">
      <app-comp-viewdeadline [vpvActive]="vpvActive" [combinedPerm]="combinedPerm"></app-comp-viewdeadline>
    </div>

    <div *ngIf="currentView == 'Deliveries'">
      <app-comp-viewdelivery [vpvActive]="vpvActive" [combinedPerm]="combinedPerm"></app-comp-viewdelivery>
    </div>

    <div *ngIf="currentView == 'All'">
      <div *ngIf="hasVPPerm(permVP.ViewAudit) && hasKM(vpvActive.keyMetrics, 'Costs') && hasOrga" class="card">
        <div class="card-header" id="headingOne">
          <h5 class="mb-0">
            <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="true" aria-controls="collapseThree">
              {{ 'vpKeyMetric.lbl.metricCost' | translate }}
            </button>
          </h5>
        </div>

        <div id="collapseThree" class="collapse show" aria-labelledby="headingThree">
          <div class="card-body">
            <app-comp-viewcost [vpvActive]="vpvActive" [combinedPerm]="combinedPerm"></app-comp-viewcost>
          </div>
        </div>
      </div>
      <div *ngIf="hasKM(vpvActive.keyMetrics, 'Deadlines')" class="card">
        <div class="card-header" id="headingOne">
          <h5 class="mb-0">
            <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
              {{ 'vpKeyMetric.lbl.metricDeadline' | translate }}
            </button>
          </h5>
        </div>

        <div id="collapseOne" class="collapse show" aria-labelledby="headingOne">
          <div class="card-body">
            <app-comp-viewdeadline [vpvActive]="vpvActive" [combinedPerm]="combinedPerm"></app-comp-viewdeadline>
          </div>
        </div>
      </div>
      <div *ngIf="hasKM(vpvActive.keyMetrics, 'Deliveries')" class="card">
        <div class="card-header" id="headingTwo">
          <h5 class="mb-0">
            <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
              {{ 'vpKeyMetric.lbl.metricDelivery' | translate }}
            </button>
          </h5>
        </div>
        <div id="collapseTwo" class="collapse show" aria-labelledby="headingTwo">
          <div class="card-body">
            <app-comp-viewdelivery [vpvActive]="vpvActive" [combinedPerm]="combinedPerm"></app-comp-viewdelivery>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<ng-template #indicator let-level="level">
  <i class="fa" [ngClass]="{'fa-check-circle text-success': level == 1, 'fa-exclamation-triangle text-warning': level == 2, 'fa-exclamation-circle text-danger': level == 3}"></i>
</ng-template>

<ng-template #trafficLight let-level="level">
  <i class="fas fa-lightbulb" [ngClass]="{'text-secondary': level == 0, 'text-success': level == 1, 'text-warning': level == 2, 'text-danger': level == 3}"></i>
</ng-template>

<ng-template #highlight let-selected="selected" let-text="text">
  <span [ngClass]="{'font-weight-bold': selected == true, 'font-weight-normal': selected == false}">{{text}}</span>
</ng-template>

<!-- Modal Show Project Version Info -->
<div *ngIf="vpvActive" class="modal fade" id="VpvDetails" tabindex="-1" role="dialog" aria-labelledby="VpvDetailsTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="VpvDetailsTitle">{{ 'vpKeyMetric.titleDetailVersion' | translate }}: {{vpvActive.timestamp | date :'dd.MM.yy HH:mm'}} </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form name="VpvDetailsForm">
          <table *ngIf="vpvActive" class='table table-hover'>
            <!--Table head-->
            <thead>
              <tr>
                <th>{{ 'vpKeyMetric.lbl.name' | translate }}</th>
                <th>{{ 'vpKeyMetric.lbl.value' | translate }}</th>
                <th>{{ 'vpKeyMetric.lbl.info' | translate }}</th>
              </tr>
            </thead>
            <!--Table body-->
            <tbody>
              <tr *ngIf="vpvActive.startDate">
                <td>{{ 'vpKeyMetric.lbl.startDate' | translate }}</td>
                <td>{{ vpvActive.startDate | date :'dd.MM.yyyy'}}</td>
                <td class="d-none d-md-table-cell"></td>
              </tr>
              <tr>
                <td>{{ 'vpKeyMetric.lbl.endDate' | translate }}</td>
                <td>
                  <span *ngIf="delayEndDate > 0" class="fas fa-exclamation-circle" style="color:red"></span>
                  <span *ngIf="delayEndDate <= 0" class="fas fa-check-circle" style="color:green"></span>
                  <span> {{ vpvActive.keyMetrics.endDateCurrent | date :'dd.MM.yyyy'}}</span>
                </td>
                <td class="d-none d-md-table-cell">
                  <span *ngIf="delayEndDate > 0" class="text-danger"> {{delayEndDate | number:'1.1-1'}} {{ 'vpKeyMetric.lbl.weeksDelay' | translate }}</span>
                  <span *ngIf="delayEndDate < 0" class="text-success"> {{-delayEndDate | number:'1.1-1'}} {{ 'vpKeyMetric.lbl.weeksAhead' | translate }}</span>
                  <span *ngIf="delayEndDate == 0"> {{ 'vpKeyMetric.lbl.inTime' | translate }}</span>
                </td>
              </tr>
              <tr>
                <td>{{ 'keyMetrics.lbl.trafficLight' | translate }}</td>
                <td title="{{ vpvActive.ampelErlaeuterung }}">
                  <ng-container *ngTemplateOutlet="trafficLight; context:{level: vpvActive.ampelStatus} " ></ng-container>
                </td>
                <td class="d-none d-md-table-cell" title="{{ vpvActive.ampelErlaeuterung }}">
                  {{ getShortText(vpvActive.ampelErlaeuterung, 40) }}
                </td>
              </tr>
              <tr *ngIf="vpvActive.leadPerson">
                <td>{{ 'vpKeyMetric.lbl.leadPerson' | translate }}</td>
                <td title="{{ vpvActive.leadPerson }}">
                  {{ getShortText(vpvActive.leadPerson, 20) }}
                </td>
                <td></td>
              </tr>
              <tr *ngIf="vpvActive.description">
                <td>{{ 'vpKeyMetric.lbl.description' | translate }}</td>
                <td title="{{ vpvActive.description }}">
                  {{ getShortText(vpvActive.description, 20) }}
                </td>
                <td></td>
              </tr>
              <tr *ngIf="vpvActive.VorlagenName">
                <td>{{ 'vpKeyMetric.lbl.template' | translate }}</td>
                <td title="{{ vpvActive.VorlagenName }}">
                  {{ getShortText(vpvActive.VorlagenName, 20) }}
                </td>
                <td></td>
              </tr>
              <tr *ngIf="vpvActive.businessUnit">
                <td>{{ 'vpKeyMetric.lbl.bu' | translate }}</td>
                <td title="{{ vpvActive.businessUnit }}">
                  {{ getShortText(vpvActive.businessUnit, 20) }}
                </td>
                <td></td>
              </tr>
            </tbody>
          </table>

          <div class="modal-footer align-items-end">
            <button class="btn btn-primary" data-dismiss="modal">{{ 'vpKeyMetric.btn.back' | translate }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
